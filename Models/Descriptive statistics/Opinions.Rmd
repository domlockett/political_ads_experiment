---
header-includes:
  - \usepackage{subfig}

output: pdf_document
classoption: landscape

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_chunk$set(message = FALSE) # The summarize() warning really is relevant so I just turn off warnings
library(descr)
library(readr)
#library(RnBeads)
library(magick)
library(dplyr)
library(magrittr)
library(grid)
library(kableExtra)
library(stringr)
library(gridExtra)
library(knitr)
library(ggplot2)
library(gtable)
library(labelled)
library(haven)
library(png)
library(tidyverse)
tass2 <- read.csv(file = 'TASS2_Redacted.csv', header = TRUE, stringsAsFactors = FALSE)
```
# Opinions on political advertisments: allowance of real ads, curation of ads by online media \& circumstances under which ads should be removed 

```{r PID broad, echo=FALSE}
#PID
tass2$pid <- NA 
tass2$pid[tass2$PartyID7 == -1 ] = NA
tass2$pid[tass2$PartyID7 == 4 ] = "Moderate/Independent/None"
tass2$pid[tass2$PartyID7 < 4 & tass2$PartyID7 > 0] = "Democrat"
tass2$pid[tass2$PartyID7 > 4 & tass2$PartyID7  < 8] = "Republican"


##Real ad opinions: Should 'insert' ad be allowed on facebook
#Identify which columns correspond to real ads
# which(colnames(tass2)=='ADS5')
# which(colnames(tass2)=='ADS12')
#ADS5:12 -> cols [164:170]
#
Ads1 <- 164:170
for(i in 1:7){
 tass2[,Ads1[i]] <- to_factor(tass2[,Ads1[i]])
 tass2[,Ads1[i]]<- recode(tass2[,Ads1[i]], "1" = "Definetly allow", 
                "2" = "Probably allow", "3" = "Probably not allow", 
                "4" = "Definetly not allow", "77" = NA_character_, 
                "98" = NA_character_, "99" = NA_character_)}

#Source names of real ads--plot titles
images <- c('Truthout-Antifa & antiracist blamed for far right/police violence','Lake
             City AntiFa-Social programs, not police, prevent crime','American Action
             News- Are Democrats stealing your vote?','Vote.org-Register to vote'
             ,'Democrats-[Spanish] Register to vote to stop Donald Trump','Daily
             Cos-Sign petition for Senator Susan Collins to vote to convict
             Trump','Turning Point Action-Sign the petition to keep police funded and
             stop Antifa violence')
topics1 <- c()
for(i in 1:7){topics1 <- rbind(topics1, paste('Should FB allow images like this:',
              images[i]))}
######################################################################################
##Opinions about platforms: How much trust/confidence do you have in X to
## appropriately handle political advertising
#Identify which columns relate to trust/confidence measures
# which(colnames(tass2)=='ADS3_A')
# which(colnames(tass2)=='ADS3_B')
# which(colnames(tass2)=='ADS3_C')

Ads2 <- 114:116

for(i in 1:3){
 tass2[,Ads2[i]] <- to_factor(tass2[,Ads2[i]])
 tass2[,Ads2[i]]<- recode(tass2[,Ads2[i]], "1" = "Great deal", 
                "2" = "Fair amount", "3" = "Not very much", 
                "4" = "None at all", "77" = NA_character_, 
                "98" = NA_character_, "99" = NA_character_)}
company <- c(' Facebook ',' Twitter ',' Google ')
topics2 <- c('How much trust and confidence do you have in' , 'to appropriately handle political advertising')


 
######################################################################################
##Broad ad opinion: X ads should be allowed if Y
# which(colnames(tass2)=='ADS4_A')
# which(colnames(tass2)=='ADS4_T')
#ADS4_A:T -> 137:156
Ads3 <- 137:156


for(i in 1:20){
 tass2[,Ads3[i]] <- to_factor(tass2[,Ads3[i]])
 tass2[,Ads3[i]]<- recode(tass2[,Ads3[i]], "1" = "Strongly agree",
                "2" = "Agree", "3" = "Agree only a little", 
                "4" = "Disagree only a little", '5' = 'Disagree',
                '6' = 'Strongly disagree',"77" = NA_character_, 
                "98" = NA_character_, "99" = NA_character_) 
  
}



topics3 <-c("Political ads should be removed if they contain false information",
 "Political ads should be allowed, even if they contain misleading information",
 "Political ads with false content should be allowed, but labeled with a
 warning","Companies should not try to label political ads as false, even if they
 containing misleading information","No political ads should be allowed at all",
 "Political candidates should always be allowed to post ads without restriction",
 "All ads on controversial topics should be removed, regardless of source","Ads
 that encourage voting should always be permitted","Ads from news organizations
 should be exempted from regulations of political advertising","Political ads from 
 news organizations should be subject to the same regulations as ads from other sources",
 "Ads that discredit voting by mail should not be permitted on social media",
 "Political ads should include information about who paid for them","Political
 advertisers should not be required to disclose their funding sources","Microtargeting
 political ads to specific audiences based on things like age, gender, and race should
 not be permitted.","Political advertisers should be allowed to select who sees their
 ads","Ads that contain misinformation about a candidate should be removed","All ads
 about candidates should be allowed, even if they contain false content","Companies
 should provide a publicly accessible database of all political ads","Ads about
 candidates or upcoming elections should be banned, but ads about social issues (e.g.,
 guns or abortion) should still be allowed","Ads from certain sources like political
 action committees (PACs) and dark money organizations should be banned")

```


## Weighted opinions about real ads 
```{r allow-real-ads, echo=FALSE, fig.height=6, fig.width=10, out.width='.49\\linewidth', results='asis'}
theme_set(theme_minimal(base_size = 18))
            
for(i in 1:length(Ads1)){
  #weighted cross tabs of PID and Real Ad opinions with frequency and percentages
  ct <- as.data.frame((freq(tass2[,Ads1[i]],w=tass2$WEIGHT,prop.r =T, plot =F)))
#colnames

  colnames(ct) <- c('Frequency','Percentage+NA','Percentage')
#whole number percentages
  ct <- round(ct,2)
  ct$Response <- rownames(ct)

  
  ct <- ct[c('Response','Percentage','Frequency','Percentage+NA')]
  ct$Response <- factor(ct$Response, levels = c("Definetly allow",
                        "Probably allow", "Probably not allow",
                        "Definetly not allow", "NA's", 'Total'))

  

  ct1 <- ct[1:4,]
#plot
  p <- ggplot(ct1[1:4,], aes(x = Response, y = Percentage)) +
      geom_bar(stat = 'identity', fill = 'coral4', width = .5) + 
      labs(title = str_wrap(paste0(topics1[i],' [Column: ',Ads1[i],']'),50),
           x='Response') +#wrap long titles
      theme(axis.text.x = element_text(angle = 45, vjust =.6))+
      scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+#wrap long xlab
      coord_cartesian(ylim=c(0,max(ct$Percentage)+5))
  
index <- c(1:5,7:8)

img <- paste0('C:/Users/', Sys.getenv("USERNAME"), '/OneDrive/Spring 2021/PolAdsTransparency/politics_user_study/Ads and Images 2-25-21/images/8557_AD_IMAGE_',index[i],'.png')


plot <- print(p)
plot

grid.newpage()
grid.table(ct, rows = NULL)

grid.newpage()


(cat('![](', img, '){width=250px}\n\n', sep = ''))

}
```



## Weighted opinions about company trust
```{r company-opinions, echo=FALSE, out.width='.49\\linewidth'}

for(i in 1:length(Ads2)){
  #weighted cross tabs of PID and Real Ad opinions with frequency and percentages
  ct <- as.data.frame((freq(tass2[,Ads2[i]],w=tass2$WEIGHT,prop.r =T, plot
                            =F)))

  colnames(ct) <- c('Frequency','Percentage+NA','Percentage')
#whole number percentages
  ct <- round(ct,2)
  ct$Response <- rownames(ct)

  
  ct <- ct[c('Response','Percentage','Frequency','Percentage+NA')]
  ct$Response <- factor(ct$Response, levels = c("Great deal",
                        "Fair amount", "Not very much",
                        "None at all", "NA's", 'Total'))

  

  ct1 <- ct[1:4,]
  p <- ggplot(ct1, aes(x = Response, y = Percentage)) +
        geom_bar(stat = 'identity', fill = 'coral4', width = .5) + 
        labs(title= str_wrap(paste0(topics2[1] , company[i] ,topics2[2],
                                    ' [Column: ',Ads2[i],']'), 50)) +#wrap long titles
        theme(axis.text.x = element_text(angle = 45, vjust =.6))+
        scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+#wrap long xlab
        coord_cartesian(ylim=c(0,max(ct$Percentage)+5))+
        theme_minimal(base_size = 16)
         
plot <- print(p)
plot

grid.newpage()
grid.table(ct, rows=NULL)
}
```


## Weighted opinions about when political ads should be allowed 
```{r political-ad-opinions, echo=FALSE, fig.height=6, fig.width=10, out.width='.49\\linewidth', results='asis'}


for(i in 1:length(Ads3)){
  #weighted cross tabs of PID and Real Ad opinions with frequency and percentages
  ct <- as.data.frame((freq(tass2[,Ads3[i]],weights=tass2$WEIGHT,prop.r =T, 
                            plot =F)))
  colnames(ct) <- c('Frequency','Percentage+NA','Percentage')
#whole number percentages
  ct <- round(ct,2)
  ct$Response <- rownames(ct)
  ct <- ct[c('Response','Percentage','Frequency','Percentage+NA')]
  
  ct$Response <- factor(ct$Response, levels = c("Strongly agree",
                        "Agree", "Agree only a little",
                        "Disagree only a little","Disagree", 
                        "Strongly disagree", "NA's", 'Total'))

  

  ct1 <- ct[1:6,]
#plot
p <- ggplot(ct1, aes(x = Response, y = Percentage)) +
      geom_bar(stat = 'identity', fill = 'coral4', width = .5) + 
      labs(title=str_wrap(paste0(topics3[i],' [Column: ',Ads3[i],']'),50)) + #wrap long titles
      theme(axis.text.x = element_text(angle = 45, vjust =.6))+
      scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+#wrap long xlab
      coord_cartesian(ylim=c(0,max(ct$Percentage)+5))


plot <- print(p)
plot

grid.newpage()
grid.table(ct, rows = NULL)


}
```


```{r political-ad-compact, echo=FALSE, fig.height=6, fig.width=10, out.width='.49\\linewidth', results='asis'}


wtd.ci <- function(x, weights, conf.level = 0.95) {
  require(Hmisc)
  nx <- length(x)
  df <- nx - 1
  vx <- wtd.var(x, weights, normwt = TRUE) ## From Hmisc
  mx <- weighted.mean(x, weights, na.rm=T)
  stderr <- sqrt(vx/nx)
  tstat <- mx/stderr ## not mx - mu
  alpha <- 1 - conf.level
  cint <- qt(1 - alpha/2, df)
  cint <- tstat + c(-cint, cint)
  CI <- c(cint * stderr)
  c( Estimate=mx,"CI lower"=CI[1],"CI upper"=CI[2],"Std. Error"=stderr)
  
}
sub <- c(144,141,143,155,156,149,148,154,150,151,145,146)
comp <- c()
for(i in 1:length(sub)){
  comp <- c(comp, which(Ads3==sub[i]))
}

or <- data.frame(matrix(nrow=12, ncol =2))
or[,1] <- topics3[comp]
or[,2] <- as.numeric(Ads3[comp])

or
new <- data.frame(matrix(nrow=12, ncol=4))
colnames(new)<-c('est','upper','lower','std. err')
for(i in 1:length(sub)){
  #weighted cross tabs of PID and Real Ad opinions with frequency and percentages
  new[i,] <- wtd.ci(as.numeric(as.factor(tass2[,sub[i]])), weights=tass2$WEIGHT)

}



new['question'] <- c('Ads encouraging voting allowed',
                                'No political ads', 
                               'All controversial ads banned', 
                               'Candidate ads banned but issue ads allowed',
                               'PACs/dark money ads banned ',
                               'Political advertisers  funding sources private',
                               'Political advertisers  funding sources displayed on ad ',
                               "Public database for companies' political ads ",                             'Advertisers choose who sees',
                               'Microtargeting ads allowed  ',
                               'News orgs exempt from political ad regulations ',
                               "News orgs'  political ads regulated" )


new$question <- factor(new$question, levels= rev(new$question))


#

scale <- c('Strongly \n agree','Agree','Agree\n a little','Disagree\n a little','Disagree', 'Strongly \n disagree')
#make plot
f2 = ggplot(new, aes(y = rev(est), x = question  ))+
          geom_pointrange(aes(y = est,ymin = lower, 
                              ymax = upper),
                          position = position_dodge(width = -.6),
                          size = .9 , color ="darkseagreen4") +
          coord_flip() + 
           xlab("")+ 
          ylab("")+ 
          theme(text=element_text(size=20))+ 
  scale_y_continuous(limits = c(1, 6),
                     breaks = seq(1,6,1), labels=scale)
f2 +  theme_light()+
   theme(axis.text.x = element_text(angle=45,vjust=0.5))+
  theme(text=element_text(size=25))+
  theme(panel.grid.minor =   element_blank(),
        panel.grid.major =   
          element_line(colour = "grey87",size=0.5))+
    theme(plot.margin = unit(c(1,1,1,1), "cm"))
ggsave("C:/Users/dl0ck/OneDrive/Fall 2021/PolAdsTransparency/politics_user_study/publish/plots/ad-reg-opin.pdf", width = 15, height = 10, units = "in")

```